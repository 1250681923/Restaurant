/*==============================================================*/
/* NOM DE SGBD :  ORACLE VERSION 10GR2                          */
/* DATE DE CREATION :  2020/8/8 23:27:25                        */
/*==============================================================*/


ALTER TABLE BILLS
   DROP CONSTRAINT FK_BILLS_ASSOCIATI_ORDER_TA;

ALTER TABLE ORDERED_LIST
   DROP CONSTRAINT FK_ORDERED__ASSOCIATI_ORDER_TA;

ALTER TABLE ORDERED_LIST
   DROP CONSTRAINT FK_ORDERED__ASSOCIATI_FOODS;

DROP TABLE ADMIN CASCADE CONSTRAINTS;

DROP INDEX ASSOCIATION_4_FK;

DROP TABLE BILLS CASCADE CONSTRAINTS;

DROP TABLE FOODS CASCADE CONSTRAINTS;

DROP TABLE ORDER_TABLES CASCADE CONSTRAINTS;

DROP INDEX ASSOCIATION_3_FK;

DROP INDEX ASSOCIATION_1_FK;

DROP TABLE ORDERED_LIST CASCADE CONSTRAINTS;

/*==============================================================*/
/* TABLE : ADMIN                                              */
/*==============================================================*/
CREATE TABLE ADMIN  (
   AD_NOM             VARCHAR2(30)                             NOT NULL,
   AD_PW             VARCHAR2(30)                             NOT NULL
);

/*==============================================================*/
/* TABLE : BILLS                                              */
/*==============================================================*/
CREATE TABLE BILLS  (
   BILLID            NUMBER(4)                       NOT NULL,
   TABLENUM           NUMBER(8)                       NOT NULL,
   ORDERNUM           NUMBER(8)                       NOT NULL,
   BILLPRICE          NUMBER(8)                       NOT NULL,
   BILLTIME          TIMESTAMP                          NOT NULL,
   SERVICESTATE       NUMBER(8)                       NOT NULL,
   PAYSTATE          NUMBER(8)                       NOT NULL,
   CONSTRAINT PK_BILLS PRIMARY KEY (BILLID)
);


/*==============================================================*/
/* INDEX : ASSOCIATION_4_FK                                   */
/*==============================================================*/
CREATE INDEX ASSOCIATION_4_FK ON BILLS (
   ORDERNUM ASC
);

/*==============================================================*/
/* TABLE : FOODS                                              */
/*==============================================================*/
CREATE TABLE FOODS  (
   FOODID             NUMBER(8)                       NOT NULL,
   FOODNAME           VARCHAR2(30)                           NOT NULL,
   FOODTYPE            VARCHAR2(30)                           NOT NULL,
   FOODPRICE          NUMBER(8)                       NOT NULL,
   FOODIMAGE           VARCHAR2(30)                           NOT NULL,
   CONSTRAINT PK_FOODS PRIMARY KEY (FOODID)
);

/*==============================================================*/
/* TABLE : ORDER_TABLES                                       */
/*==============================================================*/
CREATE TABLE ORDER_TABLES  (
   TABLENUM           NUMBER(8)                       NOT NULL,
   ORDERNUM           NUMBER(8)                       NOT NULL,
   CONSTRAINT PK_ORDER_TABLES PRIMARY KEY (ORDERNUM)
);

/*==============================================================*/
/* TABLE : ORDERED_LIST                                       */
/*==============================================================*/
CREATE TABLE ORDERED_LIST  (
   OID                NUMBER(8)                       NOT NULL,
   FOODID             NUMBER(8)                       NOT NULL,
   ORDERNUM           NUMBER(8)                       NOT NULL,
   FOODNUM            NUMBER(8)                       NOT NULL,
   ORDERPRICE         NUMBER(8)                       NOT NULL,
   TABLENUM          NUMBER(8)                       NOT NULL,
   CONSTRAINT PK_ORDERED_LIST PRIMARY KEY (OID)
);

/*==============================================================*/
/* INDEX : ASSOCIATION_1_FK                                   */
/*==============================================================*/
CREATE INDEX ASSOCIATION_1_FK ON ORDERED_LIST (
   ORDERNUM ASC
);

/*==============================================================*/
/* INDEX : ASSOCIATION_3_FK                                   */
/*==============================================================*/
CREATE INDEX ASSOCIATION_3_FK ON ORDERED_LIST (
   FOODID ASC
);

ALTER TABLE BILLS
   ADD CONSTRAINT FK_BILLS_ASSOCIATI_ORDER_TA FOREIGN KEY (ORDERNUM)
      REFERENCES ORDER_TABLES (ORDERNUM);

ALTER TABLE ORDERED_LIST
   ADD CONSTRAINT FK_ORDERED__ASSOCIATI_ORDER_TA FOREIGN KEY (ORDERNUM)
      REFERENCES ORDER_TABLES (ORDERNUM);

ALTER TABLE ORDERED_LIST
   ADD CONSTRAINT FK_ORDERED__ASSOCIATI_FOODS FOREIGN KEY (FOODID)
      REFERENCES FOODS (FOODID);
      
      
      
//从oracle 12C 开始，我们可以定义identify 来替代auto-incresment
//ex: GENERATED [ALWAYS | BY DEFAULT [ON NULL]] AS IDENTIFY [(identity_options)];

CREATE SEQUENCE OID_SEQUENCE
INCREMENT BY 1    
START WITH 1      
NOMAXVALUE       
NOCYCLE ; 

CREATE OR REPLACE TRIGGER OID_INCREASE BEFORE
INSERT ON ORDERED_LIST FOR EACH ROW
BEGIN
SELECT OID_SEQUENCE.NEXTVAL INTO:NEW.OID FROM DUAL;
END; 

CREATE SEQUENCE BILL_SEQUENCE
INCREMENT BY 1    
START WITH 1      
NOMAXVALUE       
NOCYCLE ; 

CREATE OR REPLACE TRIGGER BILL_INCREASE BEFORE
INSERT ON BILLS FOR EACH ROW
BEGIN
SELECT BILL_SEQUENCE.NEXTVAL INTO:NEW.BILLID FROM DUAL;
END; 


CREATE SEQUENCE FOOD_SEQUENCE
INCREMENT BY 1    
START WITH 1      
NOMAXVALUE       
NOCYCLE ; 

CREATE OR REPLACE TRIGGER FOOD_INCREASE BEFORE
INSERT ON FOODS FOR EACH ROW
BEGIN
SELECT FOOD_SEQUENCE.NEXTVAL INTO:NEW.FOODID FROM DUAL;
END;







INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('111', '111');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('222', '222');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('333', '333');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('444', '444');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('555', '555');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('666', '666');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('777', '777');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('888', '888');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('999', '999');
INSERT INTO ADMIN (AD_NOM, AD_PW) VALUES ('1010', '1010');

INSERT INTO FOODS (FOODID, FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('1', 'GLACES', 'DESSERTS', '3.7', 'glaces.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('POMME', 'DESSERTS', '2', 'pomme.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('COLA', 'BOISSON', '2', 'cola.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('EVIAN', 'BOISSON', '2', 'evian.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('CHOCOLATCHAUD', 'BOISSON', '2', 'chocolatchaud.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('FRITES', 'FRITES', '2', 'frites.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('MACARON', 'PATISSERIE', '2', 'macaron.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('MACARONCRANBERRY', 'PATISSERIE', '2', 'macaroncranberry.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('DOUBLECHEESE', 'BUGGER', '2', 'doublecheese.png');
INSERT INTO FOODS (FOODNAME, FOODTYPE, FOODPRICE, FOODIMAGE) VALUES ('TRIPLECHEESE', 'BUGGER', '3', 'triplecheese.png');

INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('111', '1111');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('222', '2222');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('333', '3333');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('444', '4444');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('555', '5555');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('666', '6666');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('777', '7777');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('888', '8888');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('999', '9999');
INSERT INTO ORDER_TABLES (TABLENUM, ORDERNUM) VALUES ('101', '1010');

INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('1', '111', '1111', '1', '4');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('2', '222', '2222', '1', '2');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('5', '222', '2222', '1', '2');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('1', '333', '3333', '1', '4');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('1', '444', '4444', '1', '4');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('5', '444', '4444', '1', '2');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('1', '555', '5555', '1', '4');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('2', '555', '5555', '1', '2');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('5', '555', '5555', '1', '2');
INSERT INTO ORDERED_LIST (FOODID, TABLENUM, ORDERNUM, FOODNUM, ORDERPRICE) VALUES ('4', '555', '5555', '1', '2');

INSERT INTO BILLS (TABLENUM, ORDERNUM, BILLPRICE, BILLTIME, SERVICESTATE, PAYSTATE) VALUES ('111', '1111', '4', TO_TIMESTAMP('2020-08-08 00:49:02.073000000', 'YYYY-MM-DD HH24:MI:SS.FF'), '1', '1');
INSERT INTO BILLS (TABLENUM, ORDERNUM, BILLPRICE, BILLTIME, SERVICESTATE, PAYSTATE) VALUES ('222', '2222', '4', TO_TIMESTAMP('2020-08-08 00:49:02.073000000', 'YYYY-MM-DD HH24:MI:SS.FF'), '1', '1');
INSERT INTO BILLS (TABLENUM, ORDERNUM, BILLPRICE, BILLTIME, SERVICESTATE, PAYSTATE) VALUES ('333', '3333', '4', TO_TIMESTAMP('2020-08-08 00:49:02.073000000', 'YYYY-MM-DD HH24:MI:SS.FF'), '1', '1');
INSERT INTO BILLS (TABLENUM, ORDERNUM, BILLPRICE, BILLTIME, SERVICESTATE, PAYSTATE) VALUES ('444', '4444', '6', TO_TIMESTAMP('2020-08-08 00:49:02.073000000', 'YYYY-MM-DD HH24:MI:SS.FF'), '1', '1');
INSERT INTO BILLS (TABLENUM, ORDERNUM, BILLPRICE, BILLTIME, SERVICESTATE, PAYSTATE) VALUES ('555', '5555', '10', TO_TIMESTAMP('2020-08-08 00:49:02.073000000', 'YYYY-MM-DD HH24:MI:SS.FF'), '1', '1');



/*
级联更新触发器1
*/
ALTER
TABLE  ORDERED_LIST DROP
CONSTRAINT  FK_ORDERED__ASSOCIATI_FOODS;

ALTER
TABLE  ORDERED_LIST ADD
CONSTRAINT  FK_ORDERED__ASSOCIATI_FOODS FOREIGN
KEY  (FOODID)
REFERENCES FOODS (FOODID) ON
DELETE  CASCADE  DEFERRABLE;

CREATE
OR  REPLACE  TRIGGER  TGR_TB_ORDERED_UPDATE
AFTER
UPDATE  OF  FOODID ON
FOODS
FOR
EACH ROW
BEGIN
  IF :OLD.FOODID<>:NEW.FOODID THEN
    UPDATE
ORDERED_LIST SET
FOODID=:NEW.FOODID WHERE
FOODID=:OLD.FOODID;
  END
IF;
END;
/*
级联更新触发器2
*/

ALTER
TABLE  BILLS DROP
CONSTRAINT  FK_BILLS_ASSOCIATI_ORDER_TA;

ALTER
TABLE  BILLS ADD
CONSTRAINT  FK_BILLS_ASSOCIATI_ORDER_TA FOREIGN KEY (ORDERNUM)
      REFERENCES ORDER_TABLES (ORDERNUM) ON
DELETE  CASCADE  DEFERRABLE;

CREATE
OR  REPLACE  TRIGGER  TGR_TB_BILLS_UPDATE
AFTER
UPDATE  OF  ORDERNUM ON
ORDER_TABLES
FOR
EACH ROW
BEGIN
  IF :OLD.ORDERNUM<>:NEW.ORDERNUM THEN
    UPDATE
BILLS SET
ORDERNUM=:NEW.ORDERNUM WHERE
ORDERNUM=:OLD.ORDERNUM;
  END
IF;
END;


/*
级联更新触发器3
*/
ALTER
TABLE  ORDERED_LIST DROP
CONSTRAINT  FK_ORDERED__ASSOCIATI_ORDER_TA;

ALTER
TABLE  ORDERED_LIST ADD
CONSTRAINT  FK_ORDERED__ASSOCIATI_ORDER_TA FOREIGN KEY (ORDERNUM)
      REFERENCES ORDER_TABLES (ORDERNUM) ON
DELETE  CASCADE  DEFERRABLE;

CREATE
OR  REPLACE  TRIGGER  TGR_TB_ORDEREDT_UPDATE
AFTER
UPDATE  OF  ORDERNUM ON
ORDER_TABLES
FOR
EACH ROW
BEGIN
  IF :OLD.ORDERNUM<>:NEW.ORDERNUM THEN
    UPDATE
ORDERED_LIST SET
ORDERNUM=:NEW.ORDERNUM WHERE
ORDERNUM=:OLD.ORDERNUM;
  END
IF;
END;


UPDATE FOODS SET FOODPRICE = '4' WHERE FOODID = '6';
UPDATE ORDERED_LIST SET FOODNUM = '2', ORDERPRICE = '8' WHERE OID = '1';
UPDATE FOODS SET FOODID = '3' WHERE FOODID = 1;
UPDATE FOODS SET FOODID = '1' WHERE FOODNAME = 'GLACES';
UPDATE ORDER_TABLES SET ORDERNUM = '1112' WHERE ORDERNUM = '1111';
UPDATE ORDER_TABLES SET ORDERNUM = '1111' WHERE TABLENUM = '111';


DELETE FROM ADMIN WHERE AD_NOM = '1010';
DELETE FROM ORDERED_LIST WHERE OID = '1';
DELETE FROM FOODS WHERE FOODID = '4';
DELETE FROM FOODS WHERE FOODNAME = 'COLA';
DELETE FROM ORDER_TABLES WHERE ORDERNUM = '1111';
DELETE FROM ORDER_TABLES WHERE TABLENUM = '111';


SELECT AD_PW FROM ADMIN WHERE AD_NOM='111';
SELECT * FROM FOODS WHERE FOODID = '1';
SELECT * FROM BILLS WHERE TABLENUM = '111';
SELECT SUM(BILLPRICE) FROM BILLS GROUP BY TABLENUM;
SELECT * FROM BILLS ORDER BY BILLTIME;

SELECT FOODNAME FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID 
WHERE FOODNUM IN
(
SELECT MAX(FOODNUM) FROM ORDERED_LIST
);
SELECT FOODTYPE FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID 
WHERE FOODNUM IN
(
SELECT MAX(FOODNUM) FROM ORDERED_LIST
);
SELECT FOODIMAGE FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID 
WHERE FOODNUM IN
(
SELECT MAX(FOODNUM) FROM ORDERED_LIST
);
SELECT FOODID FROM ORDERED_LIST INNER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM WHERE SERVICESTATE='0';
SELECT COUNT(ORDERED_LIST.TABLENUM) FROM ORDERED_LIST LEFT OUTER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM  WHERE PAYSTATE IS NULL GROUP BY ORDERED_LIST.ORDERNUM;


SELECT FOODNAME FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID INNER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM WHERE SERVICESTATE = '0';
SELECT FOODTYPE FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID INNER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM WHERE SERVICESTATE = '0';
SELECT FOODIMAGE FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID INNER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM WHERE SERVICESTATE = '0';
SELECT FOODNAME FROM ORDERED_LIST INNER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID INNER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM WHERE PAYSTATE = '0';
SELECT SUM(BILLS.BILLPRICE) FROM ORDERED_LIST LEFT OUTER JOIN BILLS ON ORDERED_LIST.ORDERNUM = BILLS.ORDERNUM  LEFT OUTER JOIN FOODS ON ORDERED_LIST.FOODID = FOODS.FOODID GROUP BY FOODS.FOODID;
